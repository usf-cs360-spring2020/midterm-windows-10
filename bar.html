<!DOCTYPE html>
<html lang="en">

<style type="text/css">

.axis line {
  fill: none;
  stroke: #000000;
}

div.tooltip-donut {
    position: absolute;
    text-align: center;
    padding: .1rem;
    background: #FFFFFF;
    color: #313639;
    border: 1px solid #313639;
    border-radius: 8px;
    pointer-events: none;
    font-size: 0.6rem;
}

svg {
  background-color: white;
  border: 1px solid white;
}

.icon:before {
    font-family: "Font Awesome 5 Free";
}

</style>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Bar Graph</title>

    <!-- Load Bulma from CDN (consider saving it to repository instead) -->
    <!-- https://bulma.io/ -->
    <link rel="stylesheet" href="https://jenil.github.io/bulmaswatch/darkly/bulmaswatch.min.css">

    <!-- Load Font Awesome 5 (free) icons -->

    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>

    <script src="https://d3js.org/d3.v5.min.js"></script>

    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>

</head>

  <body>

  <div id="navigation">
  </div>
  <script>
  $(function(){
    $("#navigation").load("navbar.html");
  });
  </script>


      <section class="section">
        <div class="container">
          <div class="content has-text-centered">
            <h1>Stacked Bar</h1>
            <h2>By Aditya Dixit</h2>
            <figure class="image is-1050x480">
              <h3>This is the tableu prototype</h3>
              <img src="Dashboard 3.png">
            </figure>
            <h3>This is the D3 Implementation</h3>
            <svg id="bar"></svg>
 </p>

<style>

.axis .domain {
  display: none;
}

</style>

<script>

// location of data files
let bar = 'bar_data.csv';


let config = {
  'svg': {},
  'margin': {},
  'plot': {}
};

config.svg.height = 450;
config.svg.width = config.svg.height * 1.618; // golden ratio

config.margin.top = 10;
config.margin.right = 10;
config.margin.bottom = 20;
config.margin.left = 80;

config.plot.x = config.margin.left;
config.plot.y = config.margin.top;
config.plot.width = config.svg.width - config.margin.left - config.margin.right;
config.plot.height = config.svg.height - config.margin.top - config.margin.bottom;

let margin = {top: 30, right: 20, bottom: 20, left: 70}
  , width =960
  , height = 450

  var yScale = d3.scaleBand()			// x = d3.scaleBand()
  .range([margin.top, height - margin.bottom])
  .padding(0.1)
.paddingOuter(0.2)
      .rangeRound([0, height])	// .rangeRound([0, width])
      .align(0.1);

var xScale = d3.scaleLinear()		// y = d3.scaleLinear()
      .rangeRound([0, width-200]);	// .rangeRound([height, 0]);

var zScale = d3.scaleOrdinal()
          .range(["#D73F47", "#ABA09C", "#ED7A22", "#65A9A3"]);



let svg;

// load data
d3.csv(bar, convertRow).then(drawMain);

let parseColumnName = d3.timeParse('%Y');

function convertRow(row, index) {
  // this will be our converted output row
  let out = {};
  //out.values = [];
  out.total;
  out.key = "";

  // this will be the values from each yyyy-mm column
  for (let col in row) {
    switch (col) {      // these are the text columns that do not need conversion
      // these are the columns that need to be converted to integers
      case 'Number of Alarms':
          //out[col] = parseInt(row[col]);
          break;
      // these should be our time series values

      // case 'Call Type Group':
      //   break;

      case 'Avg. Time On Scene':
        out[col]= parseFloat(row["Avg. Time On Scene"]).toFixed(2);
        break;

        case 'Neighborhooods - Analysis Boundaries':
          out[col] = row[col];
          break;

      default:
          var type = row[col];
          var value = parseInt(row["Number of Alarms"])
         out[type] = value;
         out.total = value;
         break;
    }
  }
  return out;
}

function drawMain(data) {

var output = [];
//console.log(data)

data.forEach(function(item){
  var exist = output.filter(function(v,i){
  return v["Neighborhooods - Analysis Boundaries"] == item["Neighborhooods - Analysis Boundaries"];
});
if(exist.length){
  var index = output.indexOf(exist[0]);
  var total = output[index].total + item.total;
  Object.assign(output[index], item);
  output[index].total = total;
} else{
  if(typeof item.value == 'string'){
    item.value = [item.value];
  }
  output.push(item);
}
});
  output.sort(function(a, b) { return b.total - a.total; });
  var keys = ["Potentially Life-Threatening", "Non Life-threatening", "Fire", "Alarm"];


  xScale.domain([0,320000]);


  yScale.domain(output.map(function(d) {  return d["Neighborhooods - Analysis Boundaries"]; }));

  zScale.domain(keys);
  console.log(output);
  var div = d3.select("body").append("div")
   .attr("class", "tooltip-donut")
   .style("opacity", 0);

  svg = d3.select("body").select("svg#bar")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
svg.append("g")
     .attr("class", "axis")
     .attr("transform", "translate(80,0)")
     .style("stroke","#787878")
     .call(d3.axisLeft(yScale).ticks(null, "s"));
svg.append("g")
  .attr("class", "axis")
  .attr("transform", "translate(80,420)")
  .style("stroke","#787878")

  .call(d3.axisBottom(xScale).ticks(16,"f").tickFormat(d3.formatPrefix(".0",1e5)));


svg.selectAll(".bar")
.data(d3.stack().keys(keys)(output))
.enter().append("g")
  .attr("fill", function(d) {return zScale(d.key) })
.selectAll("rect").data(function (d){ return d; })
.enter().append("rect")
//.attr("class", "bar")
.attr("transform", "translate(80,0)")
.attr("y", function(d) { return yScale(d.data["Neighborhooods - Analysis Boundaries"]) })
.attr("x", function(d) { return xScale(d[0]) })
.attr("width", function(d) {return xScale(d[1]) - xScale(d[0]); })
.on("mouseover", function(d) {
  console.log(d);
        d3.select(this).transition()
               .duration('50')
               .attr('opacity', .50);

        div.transition()
               .duration(50)
               .style("opacity", 1);

      let format = d3.format(",");

      let key = Object.keys(d.data).find(key => d.data[key] === d[1]-d[0]);
      div.html(" Alarm Type: " + key + "<br>" + "Neighborhoood: "+d.data["Neighborhooods - Analysis Boundaries"] + "<br>" +"Total Number of Alarms: "+ format(d.data.total)  + "<br>" +"Average Response Time: "+d.data["Avg. Time On Scene"])
          .style("left", (d3.event.pageX - 30) + "px")
          .style("top", (d3.event.pageY - 15) + "px")

		})
  .on("mouseout", function(d) {d3.select(this).transition()
               .duration('50')
               .attr('opacity', 1)
        div.transition()
               .duration('50')
               .style("opacity", 0)
    })â€©
.transition()
.duration(2000)//time in ms
.attr("height", function(d){
    return yScale.bandwidth()
})

svg.select("#legend")
svg.append("circle").attr("cx",870).attr("cy",30).attr("r", 6).style("fill", "#65A9A3")
svg.append("circle").attr("cx",870).attr("cy",50).attr("r", 6).style("fill", "#ED7A22")
svg.append("circle").attr("cx",870).attr("cy",70).attr("r", 6).style("fill", "#ABA09C")
svg.append("circle").attr("cx",870).attr("cy",100).attr("r", 6).style("fill", "#D73F47")
svg.append("text").attr("x", 863).attr("y", 10).text("Call Type Group").style("font-size", "12px").attr("alignment-baseline","middle")
svg.append("text").attr("x", 880).attr("y", 30).text("Alarm").style("font-size", "10px").attr("alignment-baseline","middle")
svg.append("text").attr("x", 880).attr("y", 50).text("Fire").style("font-size", "10px").attr("alignment-baseline","middle")
svg.append("text").attr("x", 880).attr("y", 70).text("Non").style("font-size", "10px").attr("alignment-baseline","middle")
svg.append("text").attr("x", 880).attr("y", 80).text("Life Threatening").style("font-size", "10px").attr("alignment-baseline","middle")
svg.append("text").attr("x", 880).attr("y", 100).text("Potentially").style("font-size", "10px").attr("alignment-baseline","middle");
svg.append("text").attr("x", 880).attr("y", 110).text("Life Threatening").style("font-size", "10px").attr("alignment-baseline","middle")

svg.append('text')
    .attr('class', 'axis-title')
    .attr('x', 37)
    .attr('y',-5)
    .attr('text-anchor', 'middle')
    .style("font-size", "10px")
    .text('Neighborhoood');

svg.append('text')
  .attr('class', 'axis-title')
  .attr('x', 470)
  .attr('y', 442)
  .attr('dy', '1.75ex')
  .attr('text-anchor', 'middle')
  .style("font-size", "12px")
  .text('Number of Alarms');

  svg.append('text')
    .attr('class', 'title')
    .attr('x', 442)
    .attr('y',-25)
    .attr('dy', '1.75ex')
    .attr('text-anchor', 'middle')
    .attr("font-weight", 600)
    .style("font-size", "16")
    .text('Bar Graph of the Number of Alarms based on the areas in the last 10 years');

}

function translate(x, y) {
  return 'translate(' + x + ',' + y + ')';
}

function midpoint(range) {
    return range[0] + (range[1] - range[0]) / 2.0;
  }


</script>
<div class="content">

</div>
<h3>Analysis</h3>
<p2>

</div>

  </section>


  <div id="footer">
  </div>
  <script>
  $(function(){
    $("#footer").load("footer.html");
  });
  </script>

  </body>

</html>
